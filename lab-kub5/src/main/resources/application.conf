################################################################################
# КОНФИГУРАЦИЯ AKKA CLUSTER С MANAGEMENT И BOOTSTRAP
################################################################################
#
# Эта конфигурация настраивает:
# 1. Akka Cluster для работы в Kubernetes
# 2. Akka Management HTTP endpoint
# 3. Cluster Bootstrap для автоматического формирования кластера
# 4. Service Discovery через Kubernetes API
#
################################################################################

akka {
  
  # ============================================================================
  # 1. БАЗОВАЯ КОНФИГУРАЦИЯ АКТОР-СИСТЕМЫ
  # ============================================================================
  
  actor {
    provider = cluster  # Использовать Cluster Actor Provider
    
    # Сериализация для распределённых акторов
    serialization-bindings {
      "com.akka.kublab5.ClusterNode$Command" = jackson-json
    }
  }
  
  # ============================================================================
  # 2. НАСТРОЙКИ REMOTING (для связи между узлами)
  # ============================================================================
  
  remote.artery {
    canonical {
      # ВАЖНО: hostname берётся из переменной окружения HOSTNAME
      # В Kubernetes это имя Pod'а
      hostname = ${?HOSTNAME}
      
      # Порт для Akka Remoting (связь между узлами кластера)
      port = 25520
    }
  }
  
  # ============================================================================
  # 3. НАСТРОЙКИ КЛАСТЕРА
  # ============================================================================
  
  cluster {
    # Роли этого узла (опционально)
    roles = ["backend"]
    
    # Минимальное количество узлов для формирования кластера
    # В production обычно 3, для демо можно 1
    min-nr-of-members = 1
    
    # Автоматический даунинг (осторожно в production!)
    # Для демо включаем, в production использовать SBR
    auto-down-unreachable-after = 10s
    
    # Отключаем старые seed-nodes - используем Bootstrap!
    seed-nodes = []
    
    # Shutdown координация для graceful shutdown
    shutdown-after-unsuccessful-join-seed-nodes = 30s
  }
  
  # ============================================================================
  # 4. AKKA MANAGEMENT CONFIGURATION
  # ============================================================================
  
  management {
    
    # HTTP endpoint для Management API
    http {
      # Hostname для Management endpoint
      # В Kubernetes это обычно 0.0.0.0 (слушаем на всех интерфейсах)
      hostname = "0.0.0.0"
      
      # Порт Management endpoint
      # Этот порт используется для:
      # - Health checks
      # - Readiness probes
      # - Bootstrap contact points
      port = 8558
      
      # Bind hostname (куда биндится сокет)
      bind-hostname = "0.0.0.0"
      bind-port = 8558
    }
    
    # ============================================================================
    # 5. CLUSTER BOOTSTRAP CONFIGURATION
    # ============================================================================
    
    cluster.bootstrap {
      
      # Метод обнаружения узлов
      # Возможные значения:
      # - kubernetes-api (используем Kubernetes API)
      # - config (статический список, для локальной разработки)
      # - aws-api-ec2-tag-based (для AWS)
      # - consul (для Consul)
      contact-point-discovery {
        discovery-method = kubernetes-api
        
        # Интервал обновления списка узлов
        interval = 5s
        
        # Таймаут для запросов к Kubernetes API
        required-contact-point-nr = 1
      }
      
      # Конфигурация формирования кластера
      # Эти параметры контролируют, как узлы согласовывают membership
      contact-point {
        # Fallback порт, если не удалось определить через discovery
        fallback-port = 8558
        
        # Фильтр портов для contact points
        # Используем только Management порт
        filter-on-fallback-port = true
        
        # Таймаут для HTTP проб к другим узлам
        probe-interval = 2s
        probe-interval-jitter = 0.5s
      }
    }
  }
  
  # ============================================================================
  # 6. SERVICE DISCOVERY CONFIGURATION (Kubernetes API)
  # ============================================================================
  
  discovery {
    # Метод по умолчанию
    method = kubernetes-api
    
    kubernetes-api {
      # Имя сервиса для поиска Pod'ов
      # ВАЖНО: Это должно соответствовать имени Kubernetes Service
      # Значение берётся из переменной окружения или дефолт
      pod-label-selector = "app=akka-cluster"
      
      # Namespace, где искать Pod'ы
      # По умолчанию - namespace текущего Pod'а
      pod-namespace = ${?KUBERNETES_NAMESPACE}
      
      # Альтернатива: можно использовать имя сервиса
      # pod-label-selector не используется, если указан service-name
      # service-name = "akka-cluster-service"
      
      # Порт для contact points (Management port)
      pod-port-name = "management"
    }
  }
  
  # ============================================================================
  # 7. ЛОГИРОВАНИЕ
  # ============================================================================
  
  loglevel = "INFO"
  
  # Логирование событий кластера
  cluster.log-info = on
  cluster.log-info-verbose = off
  
  # Логирование lifecycle актор-системы
  log-dead-letters = 10
  log-dead-letters-during-shutdown = off
  
  # Логирование конфигурации при старте
  log-config-on-start = off
}

################################################################################
# ПРОФИЛИ ДЛЯ РАЗНЫХ ОКРУЖЕНИЙ
################################################################################

# Локальная разработка (без Kubernetes)
# Запуск: java -Dconfig.resource=application-local.conf ...
# Или создать отдельный файл application-local.conf
